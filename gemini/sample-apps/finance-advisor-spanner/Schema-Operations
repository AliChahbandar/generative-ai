<!-- Finvest Spanner Demo App -->

DROP INDEX IF EXISTS category_Tokens_IDX;
DROP INDEX  IF EXISTS fund_benchmark_Tokens_IDX;
DROP INDEX  IF EXISTS fund_name_Tokens_IDX;
DROP INDEX  IF EXISTS investment_managers_Substring_investment_Strategy_Tokens_Combo_IDX;
DROP INDEX  IF EXISTS investment_managers_Substring_NgRAM_investment_Strategy_Tokens_Combo_IDX;
DROP INDEX  IF EXISTS investment_managers_Substring_Tokens_IDX;
DROP INDEX  IF EXISTS investment_managers_Substring_Tokens_NGRAM_IDX;
DROP INDEX  IF EXISTS investment_managers_Tokens_IDX;
DROP INDEX  IF EXISTS investment_strategy_Tokens_IDX;
DROP INDEX  IF EXISTS morningstar_benchmark_Tokens_IDX;
DROP INDEX  IF EXISTS top5_holdings_Tokens_IDX;
DROP INDEX  IF EXISTS top5_regions_Tokens_IDX;

DROP PROPERTY GRAPH FundGraph;

ALTER TABLE EU_MutualFunds DROP COLUMN  fund_name_Tokens  ;
ALTER TABLE EU_MutualFunds DROP COLUMN  category_Tokens  ;
ALTER TABLE EU_MutualFunds DROP COLUMN  investment_strategy_Tokens ;
ALTER TABLE EU_MutualFunds DROP COLUMN  investment_managers_Tokens  ;
ALTER TABLE EU_MutualFunds DROP COLUMN  fund_benchmark_Tokens ;
ALTER TABLE EU_MutualFunds DROP COLUMN  morningstar_benchmark_Tokens  ;
ALTER TABLE EU_MutualFunds DROP COLUMN  top5_regions_Tokens  ;
ALTER TABLE EU_MutualFunds DROP COLUMN  top5_holdings_Tokens  ;
ALTER TABLE EU_MutualFunds DROP COLUMN  investment_managers_Substring_Tokens   ;
ALTER TABLE EU_MutualFunds DROP COLUMN  investment_managers_Substring_Tokens_NGRAM   ;



gcloud dataflow jobs run cloud-spanner-export-spanner-fts-mf-data --gcs-location gs://dataflow-templates-us-central1/latest/Cloud_Spanner_to_GCS_Avro --region us-central1 --num-workers 2 --worker-machine-type n2-standard-2 --staging-location gs://eu-mf-demo/temp/ --subnetwork https://www.googleapis.com/compute/v1/projects/spanner-demos-ce/regions/us-central1/subnetworks/central --disable-public-ips --additional-experiments use_runner_v2 --additional-user-labels "" --parameters instanceId=spanner-fts,databaseId=mf-data,outputDir=gs://eu-mf-demo/export/jul22/,spannerHost=https://batch-spanner.googleapis.com,shouldExportTimestampAsLogicalType=false,shouldExportRelatedTables=false,dataBoostEnabled=true


## IMPORT STEPS 

gcloud dataflow jobs run cloud-spanner-import-spanner-fts-mf-data-test --gcs-location gs://dataflow-templates-us-central1/latest/GCS_Avro_to_Cloud_Spanner --region us-central1 --num-workers 2 --worker-machine-type n2-standard-2 --staging-location gs://dataflow-staging-us-central1-473832897378/temp/ --subnetwork https://www.googleapis.com/compute/v1/projects/spanner-demos-ce/regions/us-central1/subnetworks/central --disable-public-ips --additional-experiments use_runner_v2 "" --parameters instanceId=spanner-fts,databaseId=mf-data-test,inputDir=gs://eu-mf-demo/export/jul22/spanner-fts-mf-data-2024-07-22_14_18_14-4676046613725049800/,spannerHost=https://batch-spanner.googleapis.com,waitForIndexes=false,waitForForeignKeys=false,waitForChangeStreams=true,waitForSequences=true,earlyIndexCreateFlag=true,ddlCreationTimeoutInMinutes=30


ALTER TABLE EU_MutualFunds ADD COLUMN  fund_name_Tokens TOKENLIST AS (TOKENIZE_FULLTEXT(fund_name)) HIDDEN;
ALTER TABLE EU_MutualFunds ADD COLUMN  category_Tokens TOKENLIST AS (TOKENIZE_FULLTEXT(category)) HIDDEN;
ALTER TABLE EU_MutualFunds ADD COLUMN  investment_strategy_Tokens TOKENLIST AS (TOKENIZE_FULLTEXT(investment_strategy)) HIDDEN;
ALTER TABLE EU_MutualFunds ADD COLUMN  investment_managers_Tokens TOKENLIST AS (TOKENIZE_FULLTEXT(investment_managers)) HIDDEN;
ALTER TABLE EU_MutualFunds ADD COLUMN  fund_benchmark_Tokens TOKENLIST AS (TOKENIZE_FULLTEXT(fund_benchmark)) HIDDEN;
ALTER TABLE EU_MutualFunds ADD COLUMN  morningstar_benchmark_Tokens TOKENLIST AS (TOKENIZE_FULLTEXT(morningstar_benchmark)) HIDDEN;
ALTER TABLE EU_MutualFunds ADD COLUMN  top5_regions_Tokens TOKENLIST AS (TOKENIZE_FULLTEXT(top5_regions)) HIDDEN;
ALTER TABLE EU_MutualFunds ADD COLUMN  top5_holdings_Tokens TOKENLIST AS (TOKENIZE_FULLTEXT(top5_holdings)) HIDDEN;
ALTER TABLE EU_MutualFunds ADD COLUMN  investment_managers_Substring_Tokens  TOKENLIST AS (TOKENIZE_SUBSTRING(investment_managers)) HIDDEN;

ALTER TABLE
  EU_MutualFunds ADD COLUMN investment_managers_Substring_Tokens_NGRAM TOKENLIST AS ( TOKENIZE_SUBSTRING(investment_managers,
      ngram_size_min=>2,
      ngram_size_max=>3,
      relative_search_types=>["word_prefix",
      "word_suffix"])) HIDDEN;

CREATE SEARCH INDEX
  category_Tokens_IDX
ON
  EU_MutualFunds(category_Tokens);
CREATE SEARCH INDEX
  fund_benchmark_Tokens_IDX
ON
  EU_MutualFunds(fund_benchmark_Tokens);
CREATE SEARCH INDEX
  fund_name_Tokens_IDX
ON
  EU_MutualFunds(fund_name_Tokens);
CREATE SEARCH INDEX
  investment_managers_Tokens_IDX
ON
  EU_MutualFunds(investment_managers_Tokens);
CREATE SEARCH INDEX
  investment_strategy_Tokens_IDX
ON
  EU_MutualFunds(investment_strategy_Tokens);
CREATE SEARCH INDEX
  morningstar_benchmark_Tokens_IDX
ON
  EU_MutualFunds(morningstar_benchmark_Tokens);
CREATE SEARCH INDEX
  top5_holdings_Tokens_IDX
ON
  EU_MutualFunds(top5_holdings_Tokens);
CREATE SEARCH INDEX
  top5_regions_Tokens_IDX
ON
  EU_MutualFunds(top5_regions_Tokens);
CREATE SEARCH INDEX
  investment_managers_Substring_Tokens_IDX
ON
  EU_MutualFunds(investment_managers_Substring_Tokens);
CREATE SEARCH INDEX
  investment_managers_Substring_investment_Strategy_Tokens_Combo_IDX
ON
  EU_MutualFunds(investment_managers_Substring_Tokens,
    investment_strategy_Tokens);


CREATE SEARCH INDEX
  investment_managers_Substring_NgRAM_investment_Strategy_Tokens_Combo_IDX
ON
  EU_MutualFunds(investment_strategy_Tokens,
    investment_managers_Substring_Tokens_NGRAM);
CREATE VECTOR INDEX
  InvestmentStrategyEmbeddingIndex
ON
  EU_MutualFunds(investment_strategy_Embedding_vector)
WHERE
  investment_strategy_Embedding_vector IS NOT NULL OPTIONS ( tree_depth = 2,
    num_leaves = 40,
    distance_type = 'EUCLIDEAN' );

CREATE SEARCH INDEX
  investment_managers_Substring_Tokens_with_vectors_NGRAM_IDX
ON
  EU_MutualFunds(investment_managers_Substring_Tokens_NGRAM) STORING (investment_strategy_Embedding_vector);


ALTER MODEL EmbeddingsModel SET OPTIONS (
endpoint = '//aiplatform.googleapis.com/projects/spanner-demos-ce/locations/us-central1/publishers/google/models/text-embedding-004'
)
;


CREATE OR REPLACE PROPERTY GRAPH FundGraph NODE TABLES( Companies AS Company DEFAULT LABEL PROPERTIES ALL COLUMNS,
    EU_MutualFunds AS Fund DEFAULT LABEL PROPERTIES ALL COLUMNS EXCEPT (_Injected_SearchUid,
      _Injected_VectorIndex_InvestmentStrategyEmbeddingIndex_FP8,
      _Injected_VectorIndex_InvestmentStrategyEmbeddingIndex_LeafId),
    Sectors AS Sector DEFAULT LABEL PROPERTIES ALL COLUMNS ) EDGE TABLES( FundHoldsCompany SOURCE KEY(NewMFSequence)
  REFERENCES
    Fund(NewMFSequence) DESTINATION KEY(CompanySeq)
  REFERENCES
    Company(CompanySeq) LABEL Holds PROPERTIES ALL COLUMNS,
    CompanyBelongsSector SOURCE KEY(CompanySeq)
  REFERENCES
    Company(CompanySeq) DESTINATION KEY(SectorSeq)
  REFERENCES
    Sector(SectorSeq) LABEL Belongs_To PROPERTIES ALL COLUMNS );





<!--PROD: -->


